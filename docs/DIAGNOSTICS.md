# Lyrah OS Installation Diagnostics Guide

This guide documents the diagnostic commands used to troubleshoot Lyrah OS installation and boot issues.

## Quick Diagnostic Script

When experiencing installation or boot issues, run this script from the live USB to collect diagnostic information:

```bash
# 1. Mount the installed system
sudo mount /dev/sdb2 /mnt           # Root partition
sudo mount /dev/sdb1 /mnt/boot/efi  # EFI partition

# 2. Mount a USB drive to save diagnostics
sudo mount /dev/sdcX /mnt/usb       # Replace sdcX with your USB device

# 3. Collect diagnostics
sudo bash -c '{
  echo "=== INSTALLATION LOG ==="
  cat /mnt/var/log/lyrah-install.log
  echo ""
  echo "=== /boot/ CONTENTS ==="
  ls -la /mnt/boot/
  echo ""
  echo "=== BLS ENTRIES ==="
  ls -la /mnt/boot/loader/entries/
  echo ""
  echo "=== BLS ENTRY CONTENTS ==="
  cat /mnt/boot/loader/entries/*.conf
  echo ""
  echo "=== GRUB CONFIG (first 100 lines) ==="
  head -100 /mnt/boot/grub2/grub.cfg
  echo ""
  echo "=== /etc/default/grub ==="
  cat /mnt/etc/default/grub
  echo ""
  echo "=== ESP CONTENTS ==="
  find /mnt/boot/efi/EFI -type f -ls
  echo ""
  echo "=== BOOT LOG (if system booted) ==="
  cat /mnt/var/log/lyrah-boot/latest.log 2>/dev/null || echo "No boot log found"
} > /mnt/usb/lyrah-diagnostics.txt'

# 4. Unmount everything
sudo umount /mnt/boot/efi
sudo umount /mnt
sudo umount /mnt/usb
```

## What Each Section Checks

### 1. Installation Log (`/var/log/lyrah-install.log`)

**Purpose**: Shows what happened during Calamares installation.

**What to look for**:
- ✓ All four scripts should execute: `setup-kernel.sh`, `install-bootloader.sh`, `configure-session.sh`, `post-install.sh`
- ✓ Each script should finish with `exit: 0` (success)
- ✗ Look for `FATAL`, `ERROR`, or `WARN` messages
- ✗ Timeouts (script taking >600 seconds)

**Common issues**:
- Script timeout: Process substitution hangs in chroot → Use simple redirection
- Missing files: Script can't find kernel or EFI binaries → Check staging in build workflow
- dracut failures: Missing modules or hostonly issues → Use `--no-hostonly` flag

### 2. Boot Directory Contents (`ls -la /boot/`)

**Purpose**: Verify kernel and initramfs files are installed.

**What to look for**:
- ✓ `vmlinuz-*.fc43.x86_64` - Linux kernel (should be ~17MB)
- ✓ `initramfs-*.fc43.x86_64.img` - Initial RAM filesystem (should be ~256MB)
- ✓ `loader/` directory - Contains BLS entries
- ✓ `grub2/` directory - Contains GRUB configuration

**Common issues**:
- Empty `/boot/`: setup-kernel.sh didn't run or failed
- Missing initramfs: dracut failed (check for "No '/dev/log'" warning - this is harmless)
- Wrong size initramfs (<100MB): dracut used hostonly mode instead of --no-hostonly

### 3. BLS Entries (`/boot/loader/entries/`)

**Purpose**: Boot Loader Specification entries define boot menu items.

**What to look for**:
- ✓ Two `.conf` files: normal and debug entries
- ✓ Each file should be ~300-400 bytes
- ✓ Filenames should match: `<machine-id>-<kernel-version>.conf`

**BLS Entry Format**:
```
title Lyrah OS (6.17.1-300.fc43.x86_64)
version 6.17.1-300.fc43.x86_64
linux /vmlinuz-6.17.1-300.fc43.x86_64
initrd /initramfs-6.17.1-300.fc43.x86_64.img
options root=UUID=<uuid> ro selinux=0 systemd.log_level=info
grub_users $grub_users
grub_arg --unrestricted
grub_class lyrah
```

**What to check**:
- ✓ `root=UUID=<uuid>` matches your root partition UUID (check with `blkid /dev/sdb2`)
- ✓ Kernel and initramfs paths are correct (no leading `/boot/` - paths are relative to /boot)
- ✓ `selinux=0` is present (SELinux causes boot failures on fresh installs)

**Common issues**:
- Missing entries: setup-kernel.sh didn't run
- Wrong UUID: Script used stale UUID from previous installation
- Absolute paths (e.g., `/boot/vmlinuz`): Should be relative (`/vmlinuz`)

### 4. GRUB Configuration (`/etc/default/grub`)

**Purpose**: GRUB settings that control boot menu behavior.

**Critical settings**:
```bash
GRUB_TIMEOUT=5                      # Show menu for 5 seconds
GRUB_DISTRIBUTOR="Lyrah OS"         # Display name
GRUB_ENABLE_BLSCFG=true            # ← CRITICAL: Load BLS entries
GRUB_DISABLE_OS_PROBER=true        # Don't detect other OSes
GRUB_CMDLINE_LINUX="... selinux=0" # Kernel boot parameters
```

**What to check**:
- ✓ `GRUB_ENABLE_BLSCFG=true` is present (without this, BLS entries won't load!)
- ✓ `GRUB_TIMEOUT=5` (not 0, which would hide the menu)
- ✓ `selinux=0` in GRUB_CMDLINE_LINUX

**Common issues**:
- Missing `GRUB_ENABLE_BLSCFG=true`: GRUB won't load BLS entries, only shows "UEFI Firmware Settings"
- `GRUB_TIMEOUT=0`: Menu hidden, boots first entry immediately
- Wrong distributor name: Shows "Fedora" instead of "Lyrah OS"

### 5. GRUB Menu Config (`/boot/grub2/grub.cfg`)

**Purpose**: The actual GRUB menu configuration generated by grub2-mkconfig.

**What to look for** (in first 100 lines):
```bash
# Should see these functions and settings:
load_env               # Load GRUB environment
savedefault           # Function to save default entry
load_video            # Video initialization
insmod all_video      # Load video modules
```

**Later in the file** (you may need to check manually):
```bash
# Should see BLS entry loading (around line 100-150):
blscfg                # ← CRITICAL: Command that loads BLS entries

# And/or menuentry blocks like:
menuentry 'Lyrah OS (6.17.1-300.fc43.x86_64)' {
  linux /vmlinuz-6.17.1-300.fc43.x86_64 ...
  initrd /initramfs-6.17.1-300.fc43.x86_64.img
}
```

**Common issues**:
- No `blscfg` command: grubx64.efi was built without blscfg module
- Only "UEFI Firmware Settings" menuentry: BLS entries not loaded
- grub2-mkconfig output shows only "Adding boot menu entry for UEFI Firmware Settings": BLS detection failed

### 6. ESP (EFI System Partition) Contents

**Purpose**: Verify UEFI bootloader files are installed correctly.

**Critical files**:
```
/boot/efi/EFI/BOOT/BOOTX64.EFI     # Fallback bootloader (~1.6MB)
/boot/efi/EFI/BOOT/BOOTX64.CSV     # Firmware naming hint
/boot/efi/EFI/BOOT/grub.cfg        # ESP redirect config (~147 bytes)
/boot/efi/EFI/lyrah/grubx64.efi    # Lyrah bootloader (~1.6MB)
/boot/efi/EFI/lyrah/grub.cfg       # ESP redirect config
```

**What to check**:
- ✓ BOOTX64.EFI size ~1.6MB (if smaller, it's missing modules)
- ✓ BOOTX64.CSV exists in `/EFI/BOOT/` (not `/EFI/lyrah/`)
- ✓ grub.cfg contains UUID search and configfile redirect

**ESP grub.cfg should contain**:
```
search --no-floppy --fs-uuid --set=dev <root-uuid>
set prefix=($dev)/boot/grub2
export prefix
configfile $prefix/grub.cfg
```

**Common issues**:
- Missing BOOTX64.EFI: Firmware shows "No bootable device"
- BOOTX64.CSV in wrong location: Firmware shows "UEFI OS" instead of "Lyrah OS"
- Wrong UUID in ESP grub.cfg: GRUB can't find root partition, shows grub> prompt
- grubx64.efi too small (<1MB): Missing modules like blscfg

### 7. Boot Log (`/var/log/lyrah-boot/latest.log`)

**Purpose**: Shows what happened during system boot (only available if system booted).

**What to look for**:
- Kernel messages (dmesg output)
- Failed systemd services
- Mount errors
- SELinux denials

**When to check**: After boot fails or to diagnose runtime issues.

## GRUB Command Line Diagnostics

If GRUB menu appears but doesn't show OS entries, press `c` for GRUB command line:

```grub
# Load required modules
insmod ext2
insmod part_gpt
insmod blscfg

# List all devices
ls
# Output: (hd0) (hd0,gpt1) (hd0,gpt2) ...

# Find the device with your kernel
ls (hd0,gpt2)/boot/
# Look for vmlinuz and initramfs files

# If found, set root and try loading BLS entries
set root=(hd0,gpt2)
blscfg
# This should load and display your boot menu

# If blscfg fails, manually boot:
linux /boot/vmlinuz-6.17.1-300.fc43.x86_64 root=/dev/sdb2 ro selinux=0
initrd /boot/initramfs-6.17.1-300.fc43.x86_64.img
boot
```

## Historical Issues and Fixes

### Issue 1: Plymouth Customization Warnings (Commit 07b6b9e)
**Symptom**: Build warnings about missing initrd.img files
**Cause**: Trying to customize Plymouth in non-existent isolinux directories
**Fix**: Removed redundant Plymouth customization step (handled later in build)

### Issue 2: Kernel Install /proc/ Warnings (Commit abb8d2c)
**Symptom**: 40 lines of warnings about /proc/ not mounted
**Cause**: kernel-install scriptlets running in ISO build
**Fix**: Added `--setopt=tsflags=noscripts` to skip RPM scriptlets

### Issue 3: Live ISO Kernel Panic (Commit eb2bb30)
**Symptom**: "unable to mount root fs on unknown-block(0,0)"
**Cause**: tsflags=noscripts prevented initramfs generation, conditional skip when versions matched
**Fix**: Always regenerate live initramfs with dmsquash-live module

### Issue 4: Post-Install Boot Crash (Commit 59877c2)
**Symptom**: System crashes immediately after installation
**Cause**: dracut without --no-hostonly creates incomplete initramfs in Calamares chroot
**Fix**: Added `dracut --no-hostonly` flag

### Issue 5: Firmware Shows "UEFI OS" (Commit 7be33cb)
**Symptom**: UEFI firmware menu shows "UEFI OS" instead of "Lyrah OS"
**Cause**: BOOTX64.CSV in wrong directory (/EFI/lyrah/ instead of /EFI/BOOT/)
**Fix**: Create BOOTX64.CSV in /EFI/BOOT/ directory

### Issue 6: No GRUB Menu (Commit ca1239d)
**Symptom**: GRUB timeout never triggered, boots immediately
**Cause**: GRUB_TIMEOUT not set because /etc/default/grub already existed
**Fix**: Always overwrite /etc/default/grub instead of conditional check

### Issue 7: Installation Scripts Not Executing (Commit 85ba2fb)
**Symptom**: Kernel files and bootloader missing after installation
**Cause**: Calamares 3.3.14 doesn't support shellprocess@instance syntax
**Fix**: Consolidated all scripts into single shellprocess.conf

### Issue 8: Installation Timeout (Commit 8bcb189)
**Symptom**: "External command failed to finish in 30 seconds"
**Cause**: Process substitution `>(tee -a)` hanging in chroot, default 30s timeout
**Fix**: Use simple append redirection `>>`, increase timeout to 600s

### Issue 9: GRUB Shows Only "UEFI" Entry (Commit a5dfb88)
**Symptom**: GRUB menu shows only "UEFI Firmware Settings", no OS entries
**Cause**: Missing GRUB_ENABLE_BLSCFG=true in /etc/default/grub
**Fix**: Added GRUB_ENABLE_BLSCFG=true to enable BLS entry loading

### Issue 10: GRUB Can't Find Root (Commit 6aaf1dd)
**Symptom**: GRUB loads but can't see BLS entries, blscfg command fails
**Cause**: grubx64.efi built without blscfg module
**Fix**: Added `blscfg` to grub2-mkimage module list

## Troubleshooting Checklist

When diagnosing installation issues, check in this order:

1. **Installation completed?**
   - Check if `/var/log/lyrah-install.log` exists and has all 4 scripts
   - All scripts should exit with code 0

2. **Kernel files installed?**
   - `/boot/vmlinuz-*.x86_64` exists (~17MB)
   - `/boot/initramfs-*.img` exists (~256MB)

3. **BLS entries created?**
   - `/boot/loader/entries/*.conf` files exist (2 files)
   - UUIDs match root partition (`blkid /dev/sdb2`)

4. **GRUB configured for BLS?**
   - `/etc/default/grub` has `GRUB_ENABLE_BLSCFG=true`
   - `/boot/grub2/grub.cfg` exists and is not empty

5. **GRUB binary has BLS support?**
   - `/boot/efi/EFI/lyrah/grubx64.efi` is ~1.6MB
   - Can run `blscfg` command from GRUB prompt

6. **ESP files correct?**
   - `/boot/efi/EFI/BOOT/BOOTX64.EFI` exists
   - `/boot/efi/EFI/BOOT/BOOTX64.CSV` exists (not in /lyrah/)
   - ESP grub.cfg has correct root UUID

If all checks pass but GRUB still doesn't show entries, try manual boot from GRUB command line to verify kernel and initramfs work.

## Recovery: Manual Boot from GRUB

If automated boot fails but files are present, you can manually boot:

```grub
# From GRUB command line (press 'c'):
insmod ext2
insmod part_gpt
set root=(hd0,gpt2)  # Adjust based on 'ls' output
linux /boot/vmlinuz-6.17.1-300.fc43.x86_64 root=/dev/sdb2 ro selinux=0
initrd /boot/initramfs-6.17.1-300.fc43.x86_64.img
boot
```

Once booted, regenerate grub.cfg:
```bash
sudo grub2-mkconfig -o /boot/grub2/grub.cfg
```

## Additional Diagnostics

### Check Filesystem Corruption
```bash
# From live USB
sudo umount /dev/sdb2
sudo fsck -fy /dev/sdb2
```

### Check UEFI NVRAM Entries
```bash
# From installed system or live USB with efivarfs mounted
efibootmgr -v | grep -i lyrah
```

### Check Kernel Module Dependencies
```bash
# From installed system
lsinitrd /boot/initramfs-*.img | grep -E "drm|plymouth|dmsquash"
```

### Monitor Boot Process
```bash
# Add to kernel command line for verbose boot:
systemd.log_level=debug systemd.log_target=console console=tty0 rd.shell rd.debug
```

## Contact / Support

For persistent issues not covered in this guide, collect diagnostics with the script above and share:
1. Full `lyrah-diagnostics.txt` output
2. Photos of GRUB menu or error screens
3. Description of when the issue occurs (during install, at boot, etc.)

## Related Documentation

- `docs/build.md` - ISO build process
- `installer/scripts/setup-kernel.sh` - Kernel installation details
- `installer/scripts/install-bootloader.sh` - Bootloader installation details
- `/var/log/lyrah-boot/latest.log` - Runtime boot diagnostics (after installation)
