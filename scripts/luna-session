#!/bin/bash
# Luna Mode Session Launcher
# Starts gamescope with Luna UI (no KDE)
#
# NOTE (FIX #31): Targets gamescope 3.14+ (Fedora 43).

export XDG_SESSION_TYPE=wayland
export XDG_CURRENT_DESKTOP=gamescope

# On hybrid GPU laptops (AMD/Intel iGPU + NVIDIA dGPU), compositors
# can't auto-detect the right DRM device and fall back to llvmpipe
# (CPU software rendering at 90%+ CPU). Detect the integrated GPU
# and tell kwin_wayland to use it. gamescope also benefits from this.
PRIMARY_GPU=$(/usr/share/lyrah/setup/detect-primary-gpu.sh 2>/dev/null)
if [ -n "$PRIMARY_GPU" ]; then
    export KWIN_DRM_DEVICES="$PRIMARY_GPU"
fi

# Wine/DXVK environment variables
export DXVK_LOG_LEVEL=none
export VKD3D_CONFIG=dxr

# Signal files written by luna-ui before it exits:
#   luna-switch-to-desktop  → user wants KDE, exit to SDDM
#   luna-launch-steam       → user wants Steam login
SWITCH_SIGNAL="/tmp/luna-switch-to-desktop"
STEAM_SIGNAL="/tmp/luna-launch-steam"
rm -f "$SWITCH_SIGNAL" "$STEAM_SIGNAL"

# Log everything for diagnostics
exec &> >(systemd-cat -t luna-session)

echo "luna-session: starting at $(date)"

# ── Helper: check signal files after compositor exits ──
handle_signals() {
    if [ -f "$SWITCH_SIGNAL" ]; then
        rm -f "$SWITCH_SIGNAL" "$STEAM_SIGNAL"
        echo "luna-session: switching to Desktop Mode..."
        export XDG_CURRENT_DESKTOP=KDE
        export QT_QPA_PLATFORM=wayland
        exec startplasma-wayland
    fi

    if [ -f "$STEAM_SIGNAL" ]; then
        rm -f "$STEAM_SIGNAL"
        return 1  # caller should launch Steam
    fi

    return 0  # no action needed
}

# ── Compositor wrapper: run a command with the active compositor ──
# $COMPOSITOR is set after detection below.
run_compositor() {
    if [ "$1" = "steam" ]; then
        # Always use kwin_wayland for Steam login/setup, even when
        # gamescope is the primary compositor. Steam's multi-window
        # startup (bootstrap, update dialog, CEF login) needs a full
        # desktop compositor.
        #
        # Detailed diagnostics are written to STEAM_LOG so the user
        # can review them from KDE Plasma Desktop.
        STEAM_LOG="/var/log/lyrah/steam-login-debug.log"
        mkdir -p /var/log/lyrah 2>/dev/null

        # ── Diagnostic header ──
        {
            echo "========================================="
            echo "LYRAH OS - STEAM LOGIN DIAGNOSTICS"
            echo "Date: $(date)"
            echo "========================================="
            echo ""
            echo "--- Environment ---"
            echo "USER: $USER"
            echo "HOME: $HOME"
            echo "DISPLAY: ${DISPLAY:-<not set>}"
            echo "WAYLAND_DISPLAY: ${WAYLAND_DISPLAY:-<not set>}"
            echo "XDG_SESSION_TYPE: ${XDG_SESSION_TYPE:-<not set>}"
            echo "XDG_RUNTIME_DIR: ${XDG_RUNTIME_DIR:-<not set>}"
            echo "KWIN_DRM_DEVICES: ${KWIN_DRM_DEVICES:-<not set>}"
            echo "COMPOSITOR (luna-session): $COMPOSITOR"
            echo ""
            echo "--- Steam binary ---"
            STEAM_BIN=$(command -v steam 2>/dev/null || true)
            echo "Path: ${STEAM_BIN:-NOT FOUND IN PATH}"
            if [ -n "$STEAM_BIN" ]; then
                echo "File type: $(file "$STEAM_BIN" 2>/dev/null || echo unknown)"
                echo "First 3 lines:"
                head -3 "$STEAM_BIN" 2>/dev/null | sed 's/^/  /'
            fi
            echo ""
            echo "--- Steam data directories ---"
            echo "~/.local/share/Steam: $([ -d "$HOME/.local/share/Steam" ] && echo "EXISTS ($(ls "$HOME/.local/share/Steam/" 2>/dev/null | wc -l) items)" || echo "DOES NOT EXIST")"
            echo "~/.steam: $([ -d "$HOME/.steam" ] && echo "EXISTS" || echo "DOES NOT EXIST")"
            if [ -d "$HOME/.local/share/Steam" ]; then
                ls -la "$HOME/.local/share/Steam/" 2>/dev/null | head -20 | sed 's/^/  /'
            fi
            echo ""
            echo "--- DRM devices ---"
            ls -la /dev/dri/ 2>/dev/null || echo "  (no /dev/dri)"
            for card in /dev/dri/card*; do
                [ -e "$card" ] || continue
                cardname=$(basename "$card")
                drmdir="/sys/class/drm/$cardname/device/driver"
                if [ -L "$drmdir" ]; then
                    drv=$(basename "$(readlink "$drmdir")")
                    echo "  $card -> driver: $drv"
                else
                    echo "  $card -> driver: unknown (simpledrm?)"
                fi
                for conn in /sys/class/drm/"$cardname"-*/status; do
                    [ -f "$conn" ] || continue
                    connname=$(basename "$(dirname "$conn")")
                    echo "    $connname: $(cat "$conn" 2>/dev/null)"
                done
            done
            echo ""
            echo "--- Kernel command line ---"
            cat /proc/cmdline 2>/dev/null || echo "  (unreadable)"
            echo ""
            echo "--- Network (Steam needs this for first-run download) ---"
            echo "  Default route: $(ip route show default 2>/dev/null | head -1 || echo 'NONE')"
            echo "  DNS resolv: $(head -1 /etc/resolv.conf 2>/dev/null || echo 'NONE')"
            ping -c1 -W2 store.steampowered.com >/dev/null 2>&1 && echo "  store.steampowered.com: REACHABLE" || echo "  store.steampowered.com: UNREACHABLE"
            echo ""
            echo "========================================="
            echo "LAUNCHING: kwin_wayland --no-lockscreen --no-global-shortcuts -- steam"
            echo "Start time: $(date)"
            echo "========================================="
            echo ""
        } > "$STEAM_LOG"

        echo "luna-session: launching Steam via kwin_wayland (log: $STEAM_LOG)..."

        # ── Background monitor: snapshot process state at intervals ──
        (
            for delay in 3 10 30 60; do
                sleep "$delay"
                {
                    echo ""
                    echo "--- Process snapshot (${delay}s after launch) ---"
                    echo "Steam processes:"
                    ps aux 2>/dev/null | grep -i '[s]team' || echo "  (none)"
                    echo "kwin processes:"
                    ps aux 2>/dev/null | grep -i '[k]win' || echo "  (none)"
                    echo "Xwayland:"
                    ps aux 2>/dev/null | grep -i '[X]wayland' || echo "  (none)"
                } >> "$STEAM_LOG" 2>/dev/null
            done
        ) &
        MONITOR_PID=$!

        # ── Launch kwin_wayland with Steam, all output to log ──
        kwin_wayland --no-lockscreen --no-global-shortcuts -- steam >> "$STEAM_LOG" 2>&1
        STEAM_EXIT=$?

        # Kill the background monitor
        kill "$MONITOR_PID" 2>/dev/null; wait "$MONITOR_PID" 2>/dev/null

        # ── Post-mortem ──
        {
            echo ""
            echo "========================================="
            echo "STEAM SESSION ENDED"
            echo "kwin_wayland exit code: $STEAM_EXIT"
            echo "End time: $(date)"
            echo "========================================="
            echo ""
            echo "--- Remaining Steam processes ---"
            ps aux 2>/dev/null | grep -i '[s]team' || echo "  (none)"
            echo ""
            if [ -d "$HOME/.local/share/Steam/logs" ]; then
                echo "--- Steam client logs (last 30 lines of bootstrap) ---"
                tail -30 "$HOME/.local/share/Steam/logs/bootstrap_log.txt" 2>/dev/null | sed 's/^/  /' || echo "  (no bootstrap log)"
            else
                echo "--- Steam logs directory does not exist ---"
                echo "  This means Steam never completed its first-run bootstrap."
                echo "  Possible causes: no network, missing 32-bit libs, steam binary issue"
            fi
            echo ""
            echo "========================================="
            echo "View this log: cat /var/log/lyrah/steam-login-debug.log"
            echo "========================================="
        } >> "$STEAM_LOG"

        # Copy to user-accessible locations
        cp "$STEAM_LOG" "$HOME/Desktop/steam-login-debug.log" 2>/dev/null || \
        cp "$STEAM_LOG" "$HOME/steam-login-debug.log" 2>/dev/null || true

        echo "luna-session: Steam exited ($STEAM_EXIT). Log saved to $STEAM_LOG"
    elif [ "$COMPOSITOR" = "gamescope" ]; then
        gamescope --fullscreen -- "$@"
    else
        QT_QPA_PLATFORM=wayland kwin_wayland --no-lockscreen --no-global-shortcuts -- "$@"
    fi
}

# ── Detect which compositor works ──
# Try gamescope DRM mode first (ideal: lightweight, game-focused).
# If it fails quickly, fall back to kwin_wayland (works on all GPUs).
COMPOSITOR="gamescope"

echo "luna-session: testing gamescope DRM mode..."
gamescope --fullscreen -- /usr/bin/luna-ui
rc=$?

# Check signals from the first run
handle_signals
if [ $? -eq 1 ]; then
    # Steam requested on first run — launch it, then restart luna-ui
    echo "luna-session: launching Steam for login..."
    run_compositor steam
    # Fall through to main loop to restart luna-ui
elif [ $rc -eq 0 ]; then
    echo "luna-session: gamescope exited cleanly"
    exit 0
elif [ $rc -ne 0 ]; then
    # gamescope failed — try one more time after a brief wait
    sleep 2
    echo "luna-session: gamescope retry..."
    gamescope --fullscreen -- /usr/bin/luna-ui
    rc=$?
    handle_signals
    if [ $? -eq 1 ]; then
        echo "luna-session: launching Steam for login..."
        run_compositor steam
    elif [ $rc -eq 0 ]; then
        exit 0
    else
        # gamescope can't get DRM — switch to kwin_wayland for the
        # rest of this session. kwin_wayland runs luna-ui directly
        # (NOT nested inside gamescope) to avoid double compositing.
        echo "luna-session: gamescope DRM failed, using kwin_wayland"
        COMPOSITOR="kwin_wayland"
    fi
fi

# ── Main loop ──
# Restart luna-ui after Steam exits or on compositor retry.
while true; do
    echo "luna-session: starting luna-ui ($COMPOSITOR mode)"
    run_compositor /usr/bin/luna-ui
    rc=$?

    handle_signals
    if [ $? -eq 1 ]; then
        echo "luna-session: launching Steam for login..."
        run_compositor steam
        echo "luna-session: Steam exited, restarting luna-ui..."
        rm -f "$STEAM_SIGNAL"
        continue
    fi

    if [ $rc -eq 0 ]; then
        echo "luna-session: session ended cleanly"
        exit 0
    fi

    echo "luna-session: compositor exited with code $rc, restarting..."
    sleep 1
done
