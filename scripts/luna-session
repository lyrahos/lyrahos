#!/bin/bash
# Luna Mode Session Launcher
# Starts gamescope with Luna UI (no KDE)
#
# NOTE (FIX #31): Targets gamescope 3.14+ (Fedora 43).

export XDG_SESSION_TYPE=wayland
export XDG_CURRENT_DESKTOP=gamescope

# Do NOT set QT_QPA_PLATFORM — gamescope provides Xwayland for child
# apps.  Setting wayland here causes luna-ui to bypass Xwayland and
# fail silently inside gamescope's compositor.

# Wine/DXVK environment variables
export DXVK_LOG_LEVEL=none
export VKD3D_CONFIG=dxr

# Signal file: luna-ui writes this when the user chooses "Switch to Desktop".
# When present, we skip retries and exit immediately so SDDM can show
# the login screen for the user to pick Desktop Mode.
SWITCH_SIGNAL="/tmp/luna-switch-to-desktop"
rm -f "$SWITCH_SIGNAL"

# Log everything for diagnostics
exec &> >(systemd-cat -t luna-session)

echo "luna-session: starting at $(date)"

# SDDM's greeter compositor (kwin_wayland) may not have fully released
# the DRM device when this session starts.  Retry gamescope with
# increasing delays to wait for the DRM handoff to complete.
GAMESCOPE_ARGS=(--adaptive-sync --force-grab-cursor)

for attempt in 1 2 3 4 5; do
    echo "luna-session: gamescope attempt $attempt (DRM mode)"
    gamescope "${GAMESCOPE_ARGS[@]}" -- /usr/bin/luna-ui
    rc=$?

    # If user requested desktop switch, exit immediately (no retry)
    if [ -f "$SWITCH_SIGNAL" ]; then
        rm -f "$SWITCH_SIGNAL"
        echo "luna-session: user requested desktop switch, exiting"
        exit 0
    fi

    # Exit code 0 means gamescope ran and the user exited normally
    if [ $rc -eq 0 ]; then
        echo "luna-session: gamescope exited cleanly"
        exit 0
    fi

    echo "luna-session: gamescope exited with code $rc, retrying in ${attempt}s..."
    sleep "$attempt"
done

# DRM mode failed after all retries — fall back to nested mode inside
# kwin_wayland.  This adds compositor overhead but works on GPUs where
# gamescope cannot get DRM master (e.g. NVIDIA with nouveau/NVK).
echo "luna-session: DRM mode failed, falling back to kwin_wayland nested mode"
export QT_QPA_PLATFORM=wayland

# Don't use exec — we need the script alive to clean up kwin_wayland
# after gamescope exits, since kwin_wayland may not exit on its own.
kwin_wayland --no-lockscreen --no-global-shortcuts -- \
    gamescope --fullscreen "${GAMESCOPE_ARGS[@]}" -- /usr/bin/luna-ui &
KWIN_PID=$!
wait $KWIN_PID 2>/dev/null

# kwin_wayland may still be running if it didn't notice gamescope exit.
# Kill it explicitly so the session fully ends and SDDM resumes.
kill $KWIN_PID 2>/dev/null || true
sleep 0.5
kill -9 $KWIN_PID 2>/dev/null || true

rm -f "$SWITCH_SIGNAL"
echo "luna-session: session ended"
exit 0
