#!/bin/bash
# Luna Mode Session Launcher
# Starts gamescope with Luna UI (no KDE)
#
# Steam runs INSIDE gamescope (like SteamOS) via an inner script.
# This avoids DRM master handover issues between compositors that
# cause "Atomic modeset failed: Permission denied" on NVIDIA.
#
# NOTE (FIX #31): Targets gamescope 3.14+ (Fedora 43).

export XDG_SESSION_TYPE=wayland
export XDG_CURRENT_DESKTOP=gamescope

# On hybrid GPU laptops (AMD/Intel iGPU + NVIDIA dGPU), compositors
# can't auto-detect the right DRM device and fall back to llvmpipe
# (CPU software rendering at 90%+ CPU). Detect the integrated GPU
# and tell kwin_wayland to use it. gamescope also benefits from this.
PRIMARY_GPU=$(/usr/share/lyrah/setup/detect-primary-gpu.sh 2>/dev/null)
if [ -n "$PRIMARY_GPU" ]; then
    export KWIN_DRM_DEVICES="$PRIMARY_GPU"

    # On hybrid GPU systems the primary GPU might not drive the physical
    # display (e.g. eDP wired through NVIDIA while we selected AMD iGPU).
    # If simpledrm exists as a separate card, append it so kwin can render
    # on the real GPU and output to the UEFI framebuffer.
    _primary_card=$(basename "$PRIMARY_GPU")
    for _card in /dev/dri/card*; do
        [ "$(basename "$_card")" = "$_primary_card" ] && continue
        _dl="/sys/class/drm/$(basename "$_card")/device/driver"
        if [ -L "$_dl" ]; then
            case "$(basename "$(readlink "$_dl")")" in
                simple-framebuffer|simpledrm)
                    export KWIN_DRM_DEVICES="${PRIMARY_GPU}:${_card}"
                    break ;;
            esac
        fi
    done
fi

# If no render nodes exist (simpledrm / nomodeset / VM), force
# Mesa software rendering EARLY — before any compositor is launched.
# Keep KWIN_DRM_DEVICES as-is: on hybrid GPU systems, unsetting it
# causes kwin to discover secondary GPUs it can't access (Permission
# denied), which cascades into total output failure.
if ! ls /dev/dri/renderD* >/dev/null 2>&1; then
    export LIBGL_ALWAYS_SOFTWARE=1
fi

# Wine/DXVK environment variables
export DXVK_LOG_LEVEL=none
export VKD3D_CONFIG=dxr

# Signal files written by luna-ui before it exits:
#   luna-switch-to-desktop  → user wants KDE, exit to SDDM
#   luna-launch-steam       → user wants Steam login
SWITCH_SIGNAL="/tmp/luna-switch-to-desktop"
STEAM_SIGNAL="/tmp/luna-launch-steam"
GAMESCOPE_OK="/tmp/luna-gamescope-ok"
rm -f "$SWITCH_SIGNAL" "$STEAM_SIGNAL" "$GAMESCOPE_OK"

# Log everything for diagnostics.
# Primary: file log (always works).  Secondary: systemd journal.
LUNA_LOG="/tmp/luna-session.log"
exec &> >(tee "$LUNA_LOG" | systemd-cat -t luna-session 2>/dev/null)

echo "luna-session: starting at $(date)"
echo "luna-session: KWIN_DRM_DEVICES=${KWIN_DRM_DEVICES:-<unset>} LIBGL_ALWAYS_SOFTWARE=${LIBGL_ALWAYS_SOFTWARE:-<unset>}"
echo "luna-session: render nodes: $(ls /dev/dri/renderD* 2>/dev/null || echo 'NONE')"

# ── Helper: handle desktop switch ──
try_desktop_switch() {
    if [ -f "$SWITCH_SIGNAL" ]; then
        rm -f "$SWITCH_SIGNAL" "$STEAM_SIGNAL" "$GAMESCOPE_OK"
        echo "luna-session: switching to Desktop Mode..."
        export XDG_CURRENT_DESKTOP=KDE
        export QT_QPA_PLATFORM=wayland
        exec startplasma-wayland
    fi
}

# ── Create gamescope inner script ──
# Runs INSIDE gamescope's Xwayland environment. Handles the full
# luna-ui → Steam → luna-ui lifecycle WITHOUT compositor switching.
# This avoids DRM master handover issues between gamescope and
# kwin_wayland (NVIDIA atomic modeset failures).
GAMESCOPE_INNER="/tmp/luna-gamescope-inner.sh"
cat > "$GAMESCOPE_INNER" << 'INNER_EOF'
#!/bin/bash
SWITCH="/tmp/luna-switch-to-desktop"
STEAM="/tmp/luna-launch-steam"
LUNA_LOG="/tmp/luna-session.log"

# Signal that gamescope started successfully and the inner script ran
touch /tmp/luna-gamescope-ok

# ── Diagnostics: log what gamescope's Xwayland is actually presenting ──
{
    echo "========================================="
    echo "GAMESCOPE INNER DIAGNOSTICS"
    echo "Date: $(date)"
    echo "DISPLAY=$DISPLAY WAYLAND_DISPLAY=${WAYLAND_DISPLAY:-<unset>}"
    echo "--- xdpyinfo (gamescope Xwayland resolution) ---"
    xdpyinfo 2>/dev/null | grep -E 'dimensions|resolution' || echo "xdpyinfo not available"
    echo "--- xrandr (gamescope output modes) ---"
    xrandr 2>/dev/null || echo "xrandr not available"
    echo "========================================="
} >> "$LUNA_LOG" 2>/dev/null

while true; do
    /usr/bin/luna-ui

    if [ -f "$STEAM" ]; then
        rm -f "$STEAM"

        STEAM_LOG="$HOME/steam-login-debug.log"
        {
            echo "========================================="
            echo "LYRAH OS - STEAM LOGIN (inside gamescope)"
            echo "Date: $(date)"
            echo "DISPLAY: ${DISPLAY:-<not set>}"
            echo "WAYLAND_DISPLAY: ${WAYLAND_DISPLAY:-<not set>}"
            echo "DRM devices:"
            ls -la /dev/dri/ 2>/dev/null
            echo "Kernel cmdline:"
            cat /proc/cmdline 2>/dev/null
            echo "========================================="
        } > "$STEAM_LOG" 2>/dev/null

        # Track the library file to detect when login completes.
        # luna-ui only sends us here when libraryfolders.vdf is missing
        # (the "Log In" button), so once it appears, login succeeded.
        STEAM_LIB="$HOME/.local/share/Steam/steamapps/libraryfolders.vdf"
        STEAM_LIB_MTIME=""
        [ -f "$STEAM_LIB" ] && STEAM_LIB_MTIME=$(stat -c %Y "$STEAM_LIB" 2>/dev/null)

        # Suppress the hardware survey dialog before Steam starts.
        # Write a future date into Steam's registry so it skips the prompt.
        STEAM_REG="$HOME/.steam/registry.vdf"
        mkdir -p "$HOME/.steam"
        if ! grep -q "SurveyDateVersion" "$STEAM_REG" 2>/dev/null; then
            cat > "$STEAM_REG" << 'REGEOF'
"Registry"
{
	"HKLM"
	{
		"Software"
		{
			"Valve"
			{
				"Steam"
				{
					"SurveyDate"		"2030-01-01"
					"SurveyDateVersion"		"999"
				}
			}
		}
	}
}
REGEOF
            echo "luna-inner: wrote hardware survey suppression to $STEAM_REG" >> "$LUNA_LOG"
        fi

        echo "luna-inner: launching Steam for login at $(date)" >> "$LUNA_LOG"
        # Use -gamepadui (Steam Deck UI) so the login screen renders at
        # the full gamescope Xwayland resolution instead of opening a small
        # dialog window that gets upscaled with bilinear blur.
        steam -gamepadui >> "$STEAM_LOG" 2>&1 &
        STEAM_PID=$!

        # Give Steam time to fully start up before checking for login.
        # Steam touches libraryfolders.vdf during its own bootstrap
        # (even before showing the login screen), which would
        # false-trigger the mtime check and kill Steam instantly.
        echo "luna-inner: waiting 30s for Steam to start up..." >> "$LUNA_LOG"
        for _startup in $(seq 1 15); do
            kill -0 "$STEAM_PID" 2>/dev/null || break
            sleep 2
        done

        # Re-snapshot the mtime AFTER Steam's startup, so we only
        # detect actual login activity from this point forward.
        STEAM_LIB_MTIME=""
        [ -f "$STEAM_LIB" ] && STEAM_LIB_MTIME=$(stat -c %Y "$STEAM_LIB" 2>/dev/null)

        # Wait for login: libraryfolders.vdf appears or is updated,
        # then shut Steam down and return to luna-ui.
        while kill -0 "$STEAM_PID" 2>/dev/null; do
            if [ -f "$STEAM_LIB" ]; then
                NOW_MTIME=$(stat -c %Y "$STEAM_LIB" 2>/dev/null)
                if [ -z "$STEAM_LIB_MTIME" ] || [ "$NOW_MTIME" != "$STEAM_LIB_MTIME" ]; then
                    echo "luna-inner: Steam login detected, shutting down Steam" >> "$LUNA_LOG"
                    sleep 5
                    steam -shutdown >> "$STEAM_LOG" 2>&1
                    # Wait up to 10s for graceful exit
                    for _i in $(seq 1 10); do
                        kill -0 "$STEAM_PID" 2>/dev/null || break
                        sleep 1
                    done
                    kill -0 "$STEAM_PID" 2>/dev/null && kill "$STEAM_PID" 2>/dev/null
                    break
                fi
            fi
            sleep 2
        done
        wait "$STEAM_PID" 2>/dev/null
        echo "luna-inner: Steam exited at $(date)" >> "$LUNA_LOG"

        # Loop back to luna-ui after Steam exits
        continue
    fi

    # Desktop switch signal or clean exit — leave the loop
    break
done
INNER_EOF
chmod +x "$GAMESCOPE_INNER"

# ── Detect native display resolution ──
# Without explicit resolution flags, gamescope may render at a mismatched
# internal resolution and upscale to fill the display, causing fuzziness.
# Read the preferred mode from DRM (first line of the first connected output's
# modes file) and pass it as both internal (-W/-H) and output (-w/-h) resolution
# so gamescope renders at native resolution with no scaling.
NATIVE_W=1920
NATIVE_H=1080
_RES_SOURCE="default (no DRM modes found)"
echo "luna-session: scanning DRM modes files..."
for _modes in /sys/class/drm/card*-*/modes; do
    echo "luna-session:   checking $_modes ..."
    if [ -s "$_modes" ]; then
        _native=$(head -1 "$_modes")
        echo "luna-session:   -> preferred mode: '${_native:-<empty>}'"
        if [ -n "$_native" ]; then
            NATIVE_W="${_native%%x*}"
            NATIVE_H="${_native##*x}"
            _RES_SOURCE="$_modes"
            break
        fi
    else
        echo "luna-session:   -> file empty or missing"
    fi
done
echo "luna-session: native resolution ${NATIVE_W}x${NATIVE_H} (source: $_RES_SOURCE)"

# ── Gamescope mode (primary) ──
# gamescope runs the inner script which manages both luna-ui and Steam.
# This is how SteamOS works: Steam runs inside gamescope's Xwayland.
#
# Flags:
#   -W/-H  = internal Xwayland resolution (what apps see)
#   -w/-h  = output resolution (what the display gets)
#   --fullscreen           = take over the display
#   --filter nearest       = pixel-perfect scaling, no bilinear blur
#   --force-windows-fullscreen = prevent small windows (e.g. Steam login
#                                dialog) from being upscaled with filtering
GAMESCOPE_FLAGS=(
    -W "$NATIVE_W" -H "$NATIVE_H"
    -w "$NATIVE_W" -h "$NATIVE_H"
    --fullscreen
    --filter nearest
    --force-windows-fullscreen
)

echo "luna-session: starting gamescope with: ${GAMESCOPE_FLAGS[*]}"
gamescope "${GAMESCOPE_FLAGS[@]}" -- "$GAMESCOPE_INNER"
rc=$?
echo "luna-session: gamescope exited ($rc)"

try_desktop_switch

# Did the inner script run? If so, gamescope was working and the
# crash (if any) was during cleanup — session is done.
if [ -f "$GAMESCOPE_OK" ]; then
    rm -f "$GAMESCOPE_OK"
    echo "luna-session: gamescope session completed"
    exit 0
fi

# gamescope failed before inner script could run — retry once
echo "luna-session: gamescope failed, retrying..."
sleep 2
rm -f "$SWITCH_SIGNAL" "$STEAM_SIGNAL" "$GAMESCOPE_OK"

echo "luna-session: retrying gamescope with: ${GAMESCOPE_FLAGS[*]}"
gamescope "${GAMESCOPE_FLAGS[@]}" -- "$GAMESCOPE_INNER"
rc=$?
echo "luna-session: gamescope retry exited ($rc)"

try_desktop_switch

if [ -f "$GAMESCOPE_OK" ]; then
    rm -f "$GAMESCOPE_OK"
    echo "luna-session: gamescope session completed"
    exit 0
fi

# ── kwin_wayland fallback ──
# gamescope can't get DRM at all (no Vulkan, VM, simpledrm, etc.).
# Use kwin_wayland for both luna-ui and Steam.
echo "luna-session: gamescope DRM failed, using kwin_wayland"

# Check if we need software rendering
if [ -z "$KWIN_DRM_DEVICES" ] || [ ! -e "$KWIN_DRM_DEVICES" ]; then
    export LIBGL_ALWAYS_SOFTWARE=1
    echo "luna-session: no primary GPU, enabling software rendering"
else
    _cardname=$(basename "$KWIN_DRM_DEVICES")
    _drvlink="/sys/class/drm/$_cardname/device/driver"
    _drv=""
    [ -L "$_drvlink" ] && _drv=$(basename "$(readlink "$_drvlink")")
    case "$_drv" in
        simple-framebuffer|simpledrm|"")
            export LIBGL_ALWAYS_SOFTWARE=1
            echo "luna-session: primary GPU is simpledrm, enabling software rendering"
            ;;
        *)
            echo "luna-session: primary GPU is $_drv ($KWIN_DRM_DEVICES), using hardware rendering"
            ;;
    esac
fi

while true; do
    echo "luna-session: starting luna-ui (kwin_wayland mode)"
    kwin_wayland --no-lockscreen --no-global-shortcuts -- /usr/bin/luna-ui
    rc=$?

    try_desktop_switch

    if [ -f "$STEAM_SIGNAL" ]; then
        rm -f "$STEAM_SIGNAL"
        echo "luna-session: launching Steam via kwin_wayland..."
        kwin_wayland --no-lockscreen --no-global-shortcuts -- steam
        echo "luna-session: Steam exited, restarting luna-ui..."
        continue
    fi

    if [ $rc -eq 0 ]; then
        echo "luna-session: session ended cleanly"
        exit 0
    fi

    echo "luna-session: compositor exited with code $rc, restarting..."
    sleep 1
done
