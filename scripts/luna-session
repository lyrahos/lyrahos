#!/bin/bash
# Luna Mode Session Launcher
# Starts gamescope with Luna UI (no KDE)
#
# NOTE (FIX #31): Targets gamescope 3.14+ (Fedora 43).

export XDG_SESSION_TYPE=wayland
export XDG_CURRENT_DESKTOP=gamescope

# Do NOT set QT_QPA_PLATFORM — gamescope provides Xwayland for child
# apps.  Setting wayland here causes luna-ui to bypass Xwayland and
# fail silently inside gamescope's compositor.

# Wine/DXVK environment variables
export DXVK_LOG_LEVEL=none
export VKD3D_CONFIG=dxr

# Signal file: luna-ui writes this when the user chooses "Switch to Desktop".
# When present, we skip retries and exit immediately so SDDM can show
# the login screen for the user to pick Desktop Mode.
SWITCH_SIGNAL="/tmp/luna-switch-to-desktop"
rm -f "$SWITCH_SIGNAL"

# Log everything for diagnostics
exec &> >(systemd-cat -t luna-session)

echo "luna-session: starting at $(date)"

# Wait for SDDM's greeter compositor (kwin_wayland) to fully release
# the DRM device.  SDDM stops its greeter when the user session starts,
# but kwin_wayland may take a moment to exit and release DRM master.
# If we start gamescope too early it can't acquire DRM and fails.
echo "luna-session: waiting for SDDM greeter to release DRM..."
for i in $(seq 1 20); do
    if ! pgrep -x kwin_wayland > /dev/null 2>&1; then
        echo "luna-session: greeter exited after ${i}00ms"
        break
    fi
    sleep 0.1
done

# If kwin_wayland is STILL running after 2s, it's stuck — kill it so
# gamescope can take DRM master.
if pgrep -x kwin_wayland > /dev/null 2>&1; then
    echo "luna-session: greeter still alive, killing stale kwin_wayland"
    killall kwin_wayland 2>/dev/null || true
    sleep 0.5
fi

# Do NOT use --force-grab-cursor — it forces software cursor rendering,
# meaning every mouse movement triggers a full frame re-composite.
# The hardware cursor plane (default) updates independently of the
# compositor at essentially zero cost.
#
# Do NOT use --adaptive-sync globally — VRR causes frame pacing
# issues on displays that don't support it. Games can enable VRR
# individually via mangohud or gamescope env vars.
GAMESCOPE_ARGS=()

for attempt in 1 2 3 4 5; do
    echo "luna-session: gamescope attempt $attempt (DRM mode)"
    gamescope "${GAMESCOPE_ARGS[@]}" -- /usr/bin/luna-ui
    rc=$?

    # If user requested desktop switch, exit immediately (no retry)
    if [ -f "$SWITCH_SIGNAL" ]; then
        rm -f "$SWITCH_SIGNAL"
        echo "luna-session: user requested desktop switch, exiting"
        exit 0
    fi

    # Exit code 0 means gamescope ran and the user exited normally
    if [ $rc -eq 0 ]; then
        echo "luna-session: gamescope exited cleanly"
        exit 0
    fi

    echo "luna-session: gamescope exited with code $rc, retrying in ${attempt}s..."
    sleep "$attempt"
done

# All retries exhausted — do NOT fall back to kwin_wayland.
# A kwin_wayland + gamescope nested stack causes software rendering
# and 90%+ CPU usage. Instead, exit cleanly so SDDM shows the login
# screen and the user can switch to Desktop Mode.
echo "luna-session: gamescope failed after 5 attempts, exiting to SDDM"
rm -f "$SWITCH_SIGNAL"
exit 1
